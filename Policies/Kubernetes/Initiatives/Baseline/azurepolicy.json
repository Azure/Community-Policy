{
  "policyType": "Custom",
  "displayName": "Kubernetes Pod Security Standards Baseline Profile for Linux-based workloads",
  "parameters": {
    "effect": {
      "type": "String",
      "metadata": {
        "displayName": "Effect",
        "description": "Enable or disable the execution of the initative"
      },
      "allowedValues": [
        "enforceOPAConstraint",
        "disabled"
      ],
      "defaultValue": "enforceOPAConstraint"
    },
    "excludedNamespaces": {
      "type": "Array",
      "metadata": {
        "displayName": "Namespace exclusions",
        "description": "List of Kubernetes namespaces to exclude from initative evaluation."
      },
      "defaultValue": ["kube-system", "gatekeeper-system", "azure-arc"]
    }
  },
  "policyDefinitions": [
    {
      "policyDefinitionId": "/subscriptions/44d01367-c909-4ddc-94ef-9c4a4b34ed23/providers/Microsoft.Authorization/policyDefinitions/33901f1a-b110-422c-aa41-a4239dd4a831",
      "parameters": {
        "excludedNamespaces": {
          "value": "[parameters('excludedNamespaces')]"
        },
        "effect": {
          "value": "[parameters('effect')]"
        }
      }
    },
    {
      "policyDefinitionId": "/subscriptions/44d01367-c909-4ddc-94ef-9c4a4b34ed23/providers/Microsoft.Authorization/policyDefinitions/7fb520cf-edc6-46bd-9897-dbde7de1c1a7",
      "parameters": {
        "excludedNamespaces": {
          "value": "[parameters('excludedNamespaces')]"
        },
        "effect": {
          "value": "[parameters('effect')]"
        },
        "allowedCapabilities": {
          "value": [
            "CHOWN",
            "DAC_OVERRIDE",
            "FSETID",
            "FOWNER",
            "MKNOD",
            "NET_RAW",
            "SETGID",
            "SETUID",
            "SETFCAP",
            "SETPCAP",
            "NET_BIND_SERVICE",
            "SYS_CHROOT",
            "KILL",
            "AUDIT_WRITE"
          ]
        },
        "requiredDropCapabilities": {
          "value": []
        }
      }
    },
    {
      "policyDefinitionId": "/subscriptions/44d01367-c909-4ddc-94ef-9c4a4b34ed23/providers/Microsoft.Authorization/policyDefinitions/33901f1a-b110-422c-aa41-a4239dd4a81e",
      "parameters": {
        "effect": {
          "value": "[parameters('effect')]"
        },
        "excludedNamespaces": {
          "value": "[parameters('excludedNamespaces')]"
        },
        "allowedVolumeTypes": {
          "value": [
            "configMap",
            "emptyDir",
            "projected",
            "secret",
            "downwardAPI",
            "persistentVolumeClaim",
            "awsElasticBlockStore",
            "azureDisk",
            "azureFile",
            "cephFS",
            "cinder",
            "csi",
            "fc",
            "flexVolume",
            "flocker",
            "gcePersistentDisk",
            "gitRepo",
            "glusterfs",
            "iscsi",
            "nfs",
            "photonPersistentDisk",
            "portworxVolume",
            "quobyte",
            "rbd",
            "scaleIO",
            "storageos",
            "vsphereVolume"
          ]
        }
      }
    },
    {
      "policyDefinitionId": "/subscriptions/44d01367-c909-4ddc-94ef-9c4a4b34ed23/providers/Microsoft.Authorization/policyDefinitions/7fb520cf-edc6-46bd-9897-dbde7de1c1e9",
      "parameters": {
        "excludedNamespaces": {
          "value": "[parameters('excludedNamespaces')]"
        },
        "effect": {
          "value": "[parameters('effect')]"
        },
        "allowHostNetwork": {
          "value": false
        },
        "maxPort": {
          "value": 0
        },
        "minPort": {
          "value": 0
        }
      }
    },
    {
      "policyDefinitionId": "/subscriptions/44d01367-c909-4ddc-94ef-9c4a4b34ed23/providers/Microsoft.Authorization/policyDefinitions/d483e4f9-74cb-4800-8773-0398985eefd9",
      "parameters": {
        "excludedNamespaces": {
          "value": "[parameters('excludedNamespaces')]"
        },
        "effect": {
          "value": "[parameters('effect')]"
        },
        "allowedHostPaths": {
          "value": {
            "paths": [
              {
                "pathPrefix": "/dev/null ",
                "readOnly": true
              }
            ]
          }
        }
      }
    },
    {
      "policyDefinitionId": "/subscriptions/44d01367-c909-4ddc-94ef-9c4a4b34ed23/providers/Microsoft.Authorization/policyDefinitions/5de2233a-5c06-436f-8080-90045bde317d",
      "parameters": {
        "excludedNamespaces": {
          "value": "[parameters('excludedNamespaces')]"
        },
        "effect": {
          "value": "[parameters('effect')]"
        }
      }
    },
    {
      "policyDefinitionId": "/subscriptions/44d01367-c909-4ddc-94ef-9c4a4b34ed23/providers/Microsoft.Authorization/policyDefinitions/7fb520cf-edc6-46bd-9897-dbde7de1c19a",
      "parameters": {
        "effect": {
          "value": "[parameters('effect')]"
        },
        "excludedNamespaces": {
          "value": "[parameters('excludedNamespaces')]"
        },
        "runAsUserRule": {
          "value": "RunAsAny"
        },
        "runAsUserRanges": {
          "value": {
            "ranges": []
          }
        },
        "runAsGroupRule": {
          "value": "RunAsAny"
        },
        "runAsGroupRanges": {
          "value": {
            "ranges": []
          }
        },
        "supplementalGroupsRule": {
          "value": "RunAsAny"
        },
        "supplementalGroupsRanges": {
          "value": {
            "ranges": []
          }
        },
        "fsGroupRule": {
          "value": "RunAsAny"
        },
        "fsGroupRanges": {
          "value": {
            "ranges": []
          }
        }
      }
    }
  ]
}
