{
	"properties": {
		"displayName": "Not allowed VM Extensions",
		"description": "This policy governs which VM extensions that are explicitly denied.",
		"parameters": {
			"effect": {
				"type": "String",
				"metadata": {
					"displayName": "Effect",
					"description": "The effect determines what happens when the policy rule is evaluated to match"
				},
				"allowedValues": [
					"Audit",
					"Deny",
					"Disabled"
				],
				"defaultValue": "Deny"
			},
			"notAllowedExtensions": {
				"type": "Array",
				"metadata": {
					"description": "The list of extensions that will be denied. Example: BGInfo, CustomScriptExtension, JsonAADDomainExtension, VMAccessAgent.",
					"displayName": "Denied extension"
				}
			}
		},
		"policyRule": {
			"if": {
				"allOf": [
					{
						"field": "type",
						"equals": "Microsoft.Compute/virtualMachines/extensions"
					},
					{
						"field": "Microsoft.Compute/virtualMachines/extensions/type",
						"in": "[parameters('notAllowedExtensions')]"
					},
					{
						"anyOf": [
							{
								"field": "Microsoft.Compute/virtualMachines/extensions/publisher",
								"equals": "Microsoft.Azure.AzureDefenderForServers"
							},
							{
								"field": "Microsoft.Compute/virtualMachines/extensions/publisher",
								"equals": "Microsoft.Compute"
							}
						]
					}
				]
			},
			"then": {
				"effect": "[parameters('effect')]"
			}
		}
	}
}
